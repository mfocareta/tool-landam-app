<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Landslide Dam Classification Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="database.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .custom-radio:checked + label {
            border-color: #3b82f6;
            background-color: #eff6ff;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        #progress-bar { transition: width 0.4s ease-in-out; }
        .level-green { background-color: #d4edda; color: #155724; border-left: 4px solid #28a745; padding: 0.5rem; margin-bottom: 0.25rem; border-radius: 0.25rem;}
        .level-yellow { background-color: #fff3cd; color: #856404; border-left: 4px solid #ffc107; padding: 0.5rem; margin-bottom: 0.25rem; border-radius: 0.25rem;}
        .level-red { background-color: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; padding: 0.5rem; margin-bottom: 0.25rem; border-radius: 0.25rem;}
        .level-neutral { background-color: #e2e3e5; color: #383d41; border-left: 4px solid #6c757d; padding: 0.5rem; margin-bottom: 0.25rem; border-radius: 0.25rem;}
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="app" class="w-full max-w-5xl bg-white rounded-2xl shadow-lg p-6 md:p-8">
        <header id="app-header" class="text-center mb-4">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Landslide Dam Classification Tool</h1>
            <p class="text-gray-500 mt-1">Interactive guide for classifying landslide dams</p>
            <p id="db-count" class="text-xs text-gray-400 mt-1">Loading database...</p>

            <div id="dynamic-code-container" class="mt-4 text-center" style="visibility: hidden;">
                <p class="text-sm text-gray-500 mb-1">Partial Classification Code</p>
                <p id="dynamic-code-display" class="bg-gray-100 text-blue-600 font-mono text-2xl lg:text-3xl p-2 rounded-md inline-block tracking-widest min-w-[200px]"></p>
            </div>
        </header>

        <div id="progress-container" class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
        </div>
        
        <main id="content-container">
            <p class="text-center text-gray-500 p-8">Loading database...</p>
        </main>

        <footer id="navigation" class="mt-8 flex justify-between items-center" style="visibility: hidden;">
            <button id="prev-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors disabled:opacity-50">Back</button>
            <div id="step-indicator" class="text-sm text-gray-500"></div>
            <button id="next-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50">Next</button>
        </footer>
    </div>

    <script>
const classificationData = {
    alluvialPlain: [
        { name: 'Present', code: 'P', description: 'in a context with an alluvial plain' },
        { name: 'Absent', code: 'A', description: 'in a context without an alluvial plain' }
    ],
    riverbed: [
        { name: 'Fixed', code: 'F', description: 'a fixed riverbed (F)' },
        { name: 'Straight with alternate bars', code: 'S', description: 'a straight riverbed with alternate bars (S)' },
        { name: 'Braided', code: 'B', description: 'a braided riverbed (B)' },
        { name: 'Sinuous / Meandering', code: 'M', description: 'a sinuous/meandering riverbed (M)' },
        { name: 'Wandering', code: 'W', description: 'a wandering riverbed (W)' }
    ],
    grainSize: [
        { name: 'Coarse (gravel)', code: 'g', description: 'with coarse sediment transport (g)' },
        { name: 'Medium (sand)', code: 'm', description: 'with medium-sized sediment transport (m)' },
        { name: 'Fine (silt/clay)', code: 'f', description: 'with fine sediment transport (f)' }
    ],
    landslideType: [
        { name: 'Topple / Fall', code: 'T', description: 'a topple/fall (T)' },
        { name: 'Slump/Slide ', code: 'S', description: 'a slide (S)' },
        { name: 'Flow', code: 'F', description: 'a flow (F)' },
        { name: 'Complex', code: 'C', description: 'a complex landslide (C)' }
    ],
    complexCause: [
        { name: 'Slump/Slide (S)', code: 'S', description: 'a slide' },
        { name: 'Topple / Fall (T)', code: 'T', description: 'a topple/fall' },
        { name: 'Flow (F)', code: 'F', description: 'a flow' }
    ],
    velocity: [
        { name: 'Class 1 (slow)', code: '1', description: 'with slow velocity (Class 1)' },
        { name: 'Class 2 (moderate)', code: '2', description: 'with moderate velocity (Class 2)' },
        { name: 'Class 3 (rapid)', code: '3', description: 'with rapid velocity (Class 3)' }
    ],
    material: [
        { name: 'Rock', code: 'r', description: 'in rock (r)' },
        { name: 'Debris', code: 'd', description: 'in debris (d)' },
        { name: 'Earth', code: 'e', description: 'in earth (e)' },
        { name: 'Mixed', code: 'm', description: 'in mixed material (m)' }
    ],
    volume: [
        { name: '< 1,000 m³', code: '< 1.000' },
        { name: '1,000 – 10,000 m³', code: '1.000 – 10.000' },
        { name: '10,000 – 100,000 m³', code: '10.000 – 100.000' },
        { name: '100,000 – 1M m³', code: '100.000 – 1 ml' },
        { name: '1M – 10M m³', code: '1 ml – 10 ml' },
        { name: '10M – 100M m³', code: '10 ml – 100 ml' },
        { name: '> 100M m³', code: '> 100 ml' }
    ]
};

const colorMap = {
    alluvialPlain: { 'Present': '#a7f3d0', 'Absent': '#fecaca' },
    riverbed: { 'Fixed': '#67e8f9', 'Straight with alternate bars': '#a5b4fc', 'Braided': '#f0abfc', 'Sinuous / Meandering': '#fdba74', 'Wandering': '#fde047' },
    grainSize: { 'Coarse (gravel)': '#fca5a5', 'Medium (sand)': '#fdba74', 'Fine (silt/clay)': '#d4d4d8' },
    landslideType: { 'Topple / Fall': '#ef4444', 'Slide (Rot./Transl.)': '#f97316', 'Flow': '#eab308', 'Complex': '#84cc16' },
    complexCause: { 'Slide (S)': '#f97316', 'Topple / Fall (T)': '#ef4444', 'Flow (F)': '#eab308' },
    velocity: { 'Class 1 (slow)': '#22c55e', 'Class 2 (moderate)': '#f59e0b', 'Class 3 (rapid)': '#dc2626' },
    material: { 'Rock': '#78716c', 'Debris': '#ca8a04', 'Earth': '#a16207', 'Mixed': '#d6d3d1' },
    volume: {
        '< 1,000 m³': '#d1e7dd', '1,000 – 10,000 m³': '#cff4fc',
        '10,000 – 100,000 m³': '#e2e3e5', '100,000 – 1M m³': '#f8d7da',
        '1M – 10M m³': '#dbe7c9', '10M – 100M m³': '#f0e68c',
        '> 100M m³': '#ffc0cb'
    }
};

const riskLevelMapping = {
    'Probability of lake formation': {
        'extreme': 'red', 'very high': 'red', 'high': 'yellow', 'moderate': 'yellow', 'low': 'green', 'very low': 'green'
    },
    'Lake Lenght/Width ratio': {
        '>>1': 'green', '>1': 'green', '~1': 'yellow', '<<1': 'red', '<1': 'red'
    },
    'Lake formation time (up to overtopping dam)': {
        'short': 'red', 'moderately short': 'red', 'moderately long': 'yellow', 'long': 'green', 'very long': 'green'
    },
    'Lake infilling time': {
        'short': 'red', 'moderately short': 'red', 'moderately long': 'yellow', 'long': 'green', 'very long': 'green'
    },
    'Dam Height/Width ratio': {
        '>1': 'red', '~1': 'yellow', '<1': 'green', '<<1': 'green'
    },
    'Dam permeability': {
        'high': 'green', 'medium': 'yellow', 'low': 'red'
    },
    'Dam life (stability)': {
        'short': 'red', 'from short to moderately short': 'red', 'moderately short': 'red',
        'from moderately short to moderately long': 'red', 'moderately long': 'yellow',
        'long': 'green', 'very long': 'green', 'long or very long': 'green'
    },
    'Possibility of flooding downstream': {
        'very high': 'red', 'high': 'red', 'moderate': 'red', 'low': 'yellow', 'very low': 'green'
    },
    'Time to restore the original situation': {
        'long': 'red', 'very long': 'red', 'moderately long': 'yellow', 'short': 'green', 'moderately short': 'green'
    },
    'Possibility of preventing overflow': {
        'low': 'red', 'medium': 'yellow', 'high': 'green'
    }
};

function getLevelColorClass(characteristic, value) {
    const cleanedValue = (value || '').toLowerCase().trim().split(',')[0].split('(')[0].trim();
    const mapping = riskLevelMapping[characteristic];
    if (mapping && mapping[cleanedValue]) return `level-${mapping[cleanedValue]}`;
    if(value.includes(' to ')){
        const firstValue = value.split(' to ')[0].replace('from ','').trim();
        if (mapping && mapping[firstValue]) return `level-${mapping[firstValue]}`;
    }
    return 'level-neutral';
}

const categoryLabels = {
    alluvialPlain: 'Alluvial Plain',
    riverbed: 'Riverbed Type',
    grainSize: 'Grain Size',
    landslideType: 'Landslide Type',
    complexCause: 'Dam-forming Mechanism',
    velocity: 'Velocity',
    material: 'Material',
    volume: 'Landslide Volume'
};

let stepKeys = ['alluvialPlain', 'riverbed', 'grainSize', 'landslideType', 'velocity', 'volume', 'material'];

const appState = {
    currentStep: 0,
    selections: {},
    isComplex: false
};

const contentContainer = document.getElementById('content-container');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');
const stepIndicator = document.getElementById('step-indicator');
const navigation = document.getElementById('navigation');
const progressBar = document.getElementById('progress-bar');
const progressContainer = document.getElementById('progress-container');

let damTypeData = {};
let susceptibilityData = {};

function loadExternalDatabase() {
    try {
        if (typeof damTypeDatabase === 'undefined') {
            throw new Error('Database not found! Ensure database.js is present.');
        }
        
        damTypeData = damTypeDatabase;
        const dbCount = Object.keys(damTypeData).length;
        document.getElementById('db-count').textContent = `Database loaded: ${dbCount} categories`;
        console.log(`✅ Database loaded: ${dbCount} categories`);
        
        parseSusceptibilityData();
        init();
    } catch (error) {
        console.error('❌ Error loading database:', error);
        contentContainer.innerHTML = `
            <div class="text-center p-8 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-red-700 font-semibold mb-2">Error loading database</p>
                <p class="text-sm text-red-600">Ensure the file <code>database.js</code> is in the same folder as this HTML file.</p>
            </div>`;
    }
}

function parseSusceptibilityData() {
    susceptibilityData = {
        'extreme to very high': {
            '< 1.000': {'1': 'Low', '2': 'Low', '3': 'Low'},
            '1.000 – 10.000': {'1': 'Low', '2': 'Medium', '3': 'Medium'},
            '10.000 – 100.000': {'1': 'Medium', '2': 'Medium', '3': 'High'},
            '100.000 – 1 ml': {'1': 'Medium', '2': 'High', '3': 'High'},
            '1 ml – 10 ml': {'1': 'High', '2': 'High', '3': 'Very High'},
            '10 ml – 100 ml': {'1': 'High', '2': 'Very High', '3': 'Very High'},
            '> 100 ml': {'1': 'Very High', '2': 'Very High', '3': 'Very High'}
        },
        'high to moderate': {
            '< 1.000': {'1': 'Low', '2': 'Low', '3': 'Low'},
            '1.000 – 10.000': {'1': 'Low', '2': 'Low', '3': 'Medium'},
            '10.000 – 100.000': {'1': 'Low', '2': 'Medium', '3': 'Medium'},
            '100.000 – 1 ml': {'1': 'Medium', '2': 'Medium', '3': 'High'},
            '1 ml – 10 ml': {'1': 'Medium', '2': 'High', '3': 'High'},
            '10 ml – 100 ml': {'1': 'High', '2': 'High', '3': 'Very High'},
            '> 100 ml': {'1': 'High', '2': 'Very High', '3': 'Very High'}
        },
        'low to very low': {
            '< 1.000': {'1': 'Low', '2': 'Low', '3': 'Low'},
            '1.000 – 10.000': {'1': 'Low', '2': 'Low', '3': 'Low'},
            '10.000 – 100.000': {'1': 'Low', '2': 'Low', '3': 'Medium'},
            '100.000 – 1 ml': {'1': 'Low', '2': 'Medium', '3': 'Medium'},
            '1 ml – 10 ml': {'1': 'Medium', '2': 'Medium', '3': 'High'},
            '10 ml – 100 ml': {'1': 'Medium', '2': 'High', '3': 'Very High'},
            '> 100 ml': {'1': 'High', '2': 'Very High', '3': 'Very High'}
        }
    };
}

function calculateSusceptibilityClass(probability, volumeCode, velocityCode) {
    let blockKey = '';
    const probLower = (probability || '').toLowerCase().trim();
    if (probLower.includes('extreme') || probLower.includes('very high')) {
        blockKey = 'extreme to very high';
    } else if (probLower.includes('high') || probLower.includes('moderate')) {
        blockKey = 'high to moderate';
    } else if (probLower.includes('low') || probLower.includes('very low')) {
        blockKey = 'low to very low';
    } else {
        return 'Not definable';
    }
    
    const block = susceptibilityData[blockKey];
    if (block && block[volumeCode] && block[volumeCode][velocityCode]) {
        return block[volumeCode][velocityCode];
    }
    return 'Not definable';
}

function updateDynamicCode() {
    const container = document.getElementById('dynamic-code-container');
    const display = document.getElementById('dynamic-code-display');

    if (appState.currentStep >= stepKeys.length) {
        container.style.visibility = 'hidden';
        return;
    }
    
    container.style.visibility = 'visible';

    const codeParts = ['riverbed', 'grainSize', 'landslideType', 'velocity', 'material'].map(key => {
        let currentKey = key;
        if (key === 'landslideType' && appState.isComplex && appState.selections.complexCause) {
             return appState.selections.complexCause.code;
        }
        return appState.selections[currentKey] ? appState.selections[currentKey].code : '_';
    });

    display.textContent = codeParts.join('');
}


function renderQuestion(title, question, options, stateKey) {
    const optionsHtml = options.map((option) => {
        const isSelected = appState.selections[stateKey]?.code === option.code;
        return `
        <div>
            <input type="radio" name="${stateKey}" id="${stateKey}-${option.code}" value="${option.code}" class="hidden custom-radio" ${isSelected ? 'checked' : ''}>
            <label for="${stateKey}-${option.code}" class="block cursor-pointer border-2 border-gray-200 rounded-lg p-4 text-center hover:border-blue-400 transition-all">
                <span class="font-semibold text-gray-700">${option.name}</span>
            </label>
        </div>`;
    }).join('');
    
    contentContainer.innerHTML = `<div class="fade-in"><h2 class="text-xl font-semibold text-gray-700 mb-2">${title}</h2><p class="text-gray-600 mb-6">${question}</p><div class="grid grid-cols-1 sm:grid-cols-2 gap-4">${optionsHtml}</div></div>`;
    
    document.querySelectorAll(`input[name="${stateKey}"]`).forEach(radio => {
        radio.addEventListener('change', (e) => {
            appState.selections[stateKey] = options.find(opt => opt.code === e.target.value);
            updateDynamicCode();
            updateNavigation();
        });
    });
    updateNavigation();
}

function updateProgressBar() {
    const totalSteps = stepKeys.length;
    const progress = appState.currentStep > 0 ? (appState.currentStep / totalSteps) * 100 : 0;
    progressBar.style.width = `${progress}%`;
}

function renderStep() {
    updateDynamicCode();
    updateProgressBar();
    prevBtn.disabled = appState.currentStep === 0;

    if (appState.currentStep >= stepKeys.length) {
        renderResult();
        return;
    }

    const currentKey = stepKeys[appState.currentStep];
    let options = classificationData[currentKey];
    let questionTitle = categoryLabels[currentKey];
    let questionText = `Select the option for: ${questionTitle}`;

    if (currentKey === 'riverbed' && appState.selections.alluvialPlain) {
        options = appState.selections.alluvialPlain.code === 'A' 
            ? classificationData.riverbed.filter(opt => opt.code === 'F')
            : classificationData.riverbed.filter(opt => opt.code !== 'F');
        if (appState.selections.riverbed && !options.some(opt => opt.code === appState.selections.riverbed.code)) {
            appState.selections.riverbed = null;
        }
    } else if (currentKey === 'grainSize' && appState.selections.riverbed?.code === 'B') {
        options = classificationData.grainSize.filter(opt => opt.code !== 'f');
        if (appState.selections.grainSize && !options.some(opt => opt.code === appState.selections.grainSize.code)) {
            appState.selections.grainSize = null;
        }
    } else if (currentKey === 'velocity') {
        if ((appState.selections.landslideType?.code === 'T' && !appState.isComplex) ||
            (appState.isComplex && appState.selections.complexCause?.code === 'T')) {
            appState.selections.velocity = classificationData.velocity.find(v => v.code === '3');
            appState.currentStep++;
            renderStep();
            return;
        }
    }

    renderQuestion(questionTitle, questionText, options, currentKey);
    updateNavigation();
}

function renderResult() {
    const { riverbed, grainSize, landslideType, complexCause, velocity, material, alluvialPlain, volume } = appState.selections;
    
    const fullCode = `${riverbed.code}${grainSize.code}${landslideType.code}${velocity.code}${material.code}`;
    const searchCode = appState.isComplex ? `${riverbed.code}${grainSize.code}${complexCause.code}${velocity.code}${material.code}` : fullCode;
    
    let description = `The classified landslide, ${alluvialPlain.description}, has dammed ${riverbed.description}, ${grainSize.description}. `;
    
    if (appState.isComplex) {
        description += `The dam was caused by ${landslideType.description}, where the main dam-forming mechanism is ${complexCause.description}, ${velocity.description}, with a volume of ${volume.name}, affecting material ${material.description}.`;
    } else {
        description += `The dam was caused by ${landslideType.description}, ${velocity.description}, with a volume of ${volume.name}, affecting material ${material.description}.`;
    }
    
    const detailedDamInfo = damTypeData[searchCode];
    let additionalDescriptionHtml = '';
    
    if (appState.isComplex) {
        additionalDescriptionHtml = `
            <h3 class="font-semibold text-gray-700 mt-4 mb-2">Complex Landslide Management</h3>
            <div class="p-3 my-2 rounded-md bg-blue-50 border border-blue-200 text-sm">
                <p><strong>Complex Code:</strong> <span class="font-mono text-lg">${fullCode}</span></p>
                <p class="mt-2"><strong>Code for Effects Analysis:</strong> <span class="font-mono text-lg">${searchCode}</span></p>
                <p class="mt-2 text-gray-600"><em>For complex landslides, the effects analysis is based on the mechanism that actually caused the damming.</em></p>
            </div>`;
        
        if (detailedDamInfo) {
            const relevantKeys = Object.keys(detailedDamInfo).filter(key => detailedDamInfo[key] && !detailedDamInfo[key].includes('For complex landslides'));
            const filteredDetails = relevantKeys.map(key => {
                const value = detailedDamInfo[key];
                const levelClass = getLevelColorClass(key, value);
                return `<li class="${levelClass}"><strong>${key}</strong>: ${value}</li>`;
            }).join('');
            
            if (filteredDetails) {
                additionalDescriptionHtml += `
                    <h3 class="font-semibold text-gray-700 mt-4 mb-2">Effect Details (Code ${searchCode})</h3>
                    <ul class="list-none text-sm space-y-1">${filteredDetails}</ul>`;
            }
        } else {
            additionalDescriptionHtml += `<p class="text-sm text-red-600 mt-4 p-2 bg-red-50 rounded border border-red-200">Warning: No details found for code ${searchCode}.</p>`;
        }
    } else {
        if (detailedDamInfo) {
            const relevantKeys = Object.keys(detailedDamInfo).filter(key => detailedDamInfo[key]);
            const filteredDetails = relevantKeys.map(key => {
                const value = detailedDamInfo[key];
                const levelClass = getLevelColorClass(key, value);
                return `<li class="${levelClass}"><strong>${key}</strong>: ${value}</li>`;
            }).join('');
            
            if (filteredDetails) {
                additionalDescriptionHtml = `
                    <h3 class="font-semibold text-gray-700 mt-4 mb-2">Effect Details (Code ${fullCode})</h3>
                    <ul class="list-none text-sm space-y-1">${filteredDetails}</ul>`;
            }
        } else {
            additionalDescriptionHtml = `<p class="text-sm text-red-600 mt-4 p-2 bg-red-50 rounded border border-red-200">Warning: No details found for code ${fullCode}.</p>`;
        }
    }
    
    const probabilityOfLake = detailedDamInfo ? detailedDamInfo['Probability of lake formation'] : null;
    const susceptibilityClass = calculateSusceptibilityClass(probabilityOfLake, volume.code, velocity.code);
    
    let susceptibilityColorClass = 'level-neutral';
    if (susceptibilityClass === 'Low') susceptibilityColorClass = 'level-green';
    else if (susceptibilityClass === 'Medium') susceptibilityColorClass = 'level-yellow';
    else if (susceptibilityClass === 'High' || susceptibilityClass === 'Very High') susceptibilityColorClass = 'level-red';
    
    const barcodeItems = [
        { label: 'Plain', value: alluvialPlain.name, color: colorMap.alluvialPlain[alluvialPlain.name] },
        { label: 'Riverbed', value: riverbed.name, color: colorMap.riverbed[riverbed.name] },
        { label: 'Grain Size', value: grainSize.name, color: colorMap.grainSize[grainSize.name] },
        { label: 'Landslide Type', value: landslideType.name, color: colorMap.landslideType[landslideType.name] },
        ...(appState.isComplex ? [{ label: 'Cause', value: complexCause.name, color: colorMap.complexCause[complexCause.name] }] : []),
        { label: 'Velocity', value: velocity.name, color: colorMap.velocity[velocity.name] },
        { label: 'Volume', value: volume.name, color: colorMap.volume[volume.name] },
        { label: 'Material', value: material.name, color: colorMap.material[material.name] }
    ];
    
    const colorBarHtml = barcodeItems.map(item => 
        `<div class="h-full flex-1" style="background-color: ${item.color};" title="${item.label}: ${item.value}"></div>`
    ).join('');
    
    let colorScalesHtml = '';
    for (const categoryKey in classificationData) {
        if (categoryKey === 'complexCause' && !appState.isComplex) continue;
        const options = classificationData[categoryKey];
        let scaleItemsHtml = options.map(option => `
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 rounded-sm border" style="background-color: ${colorMap[categoryKey][option.name]};"></div>
                <span class="text-xs">${option.name}</span>
            </div>`).join('');
        colorScalesHtml += `
            <div class="p-3 bg-gray-50 rounded-lg">
                <p class="font-semibold text-sm text-gray-800 mb-2">${categoryLabels[categoryKey]}</p>
                <div class="flex flex-wrap gap-x-4 gap-y-2">${scaleItemsHtml}</div>
            </div>`;
    }
    
    contentContainer.innerHTML = `
        <div class="fade-in">
            <div id="pdf-content" class="bg-white">
                <div id="report-header" class="mb-6">
                    <h2 id="pdf-landslide-title" class="text-2xl font-bold text-center text-gray-700 break-words">&nbsp;</h2>
                </div>
                <div class="space-y-6">
                    <div class="p-4 bg-white rounded-lg border">
                        <p class="text-center font-semibold text-gray-700 mb-2">Landslide Dams Barcode</p>
                        <div class="w-full h-10 flex rounded-lg overflow-hidden shadow-inner border">${colorBarHtml}</div>
                        <p class="text-center text-5xl font-bold text-blue-600 tracking-wider mt-4">${fullCode}</p>
                        ${appState.isComplex ? `<p class="text-center text-sm text-gray-600 mt-2">Analysis Code: ${searchCode}</p>` : ''}
                    </div>
                    <div class="p-4 bg-white rounded-lg border">
                        <p class="font-semibold text-gray-700 mb-2">Description</p>
                        <p class="text-sm text-gray-600">${description}</p>
                        ${additionalDescriptionHtml}
                    </div>
                    <div class="p-4 bg-white rounded-lg border ${susceptibilityColorClass}">
                        <p class="font-semibold text-gray-700 mb-2">Susceptibility Class for Lake Formation</p>
                        <p class="text-lg font-bold text-center">${susceptibilityClass}</p>
                    </div>
                    <div class="p-4 bg-white rounded-lg border">
                        <p class="font-semibold text-gray-700 mb-3">Color Scale Legend</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">${colorScalesHtml}</div>
                    </div>
                </div>
            </div>
            <div id="pre-pdf-controls" class="my-6 p-4 border-t border-b">
                <label for="landslide-name-input" class="block text-sm font-medium text-gray-700 text-center mb-2">Classification Name (optional)</label>
                <input type="text" id="landslide-name-input" class="w-full sm:w-2/3 mx-auto block border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2 border" placeholder="E.g., Vajont Landslide, 1963">
            </div>
            <div id="action-buttons" class="text-center mt-6 flex flex-col sm:flex-row justify-center gap-4">
                <button id="save-pdf-btn" class="bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors w-full sm:w-auto">Save as PDF</button>
                <button id="reset-btn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors w-full sm:w-auto">New Classification</button>
            </div>
        </div>`;
    
    navigation.style.visibility = 'hidden';
    progressContainer.style.visibility = 'hidden';
    
    document.getElementById('reset-btn').addEventListener('click', init);
    document.getElementById('save-pdf-btn').addEventListener('click', generatePDF);
    document.getElementById('landslide-name-input').addEventListener('input', (e) => {
        document.getElementById('pdf-landslide-title').textContent = e.target.value || '\u00A0';
    });
}

async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const saveBtn = document.getElementById('save-pdf-btn');
    const appHeader = document.getElementById('app-header');
    const pdfContent = document.getElementById('pdf-content');
    
    saveBtn.disabled = true;
    saveBtn.textContent = 'Generating...';

    const printableArea = document.createElement('div');
    printableArea.style.position = 'absolute';
    printableArea.style.left = '-9999px';
    printableArea.style.width = '1200px';
    printableArea.style.backgroundColor = 'white';
    printableArea.style.padding = '20px';
    
    printableArea.appendChild(appHeader.cloneNode(true));
    printableArea.appendChild(pdfContent.cloneNode(true));
    document.body.appendChild(printableArea);

    try {
        const canvas = await html2canvas(printableArea, { scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff' });
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const canvasAspectRatio = canvas.width / canvas.height;
        
        let finalPdfWidth = pdfWidth - 20;
        let finalPdfHeight = finalPdfWidth / canvasAspectRatio;

        if (finalPdfHeight > pdfHeight - 20) {
            finalPdfHeight = pdfHeight - 20;
            finalPdfWidth = finalPdfHeight * canvasAspectRatio;
        }

        pdf.addImage(imgData, 'PNG', (pdfWidth - finalPdfWidth) / 2, 10, finalPdfWidth, finalPdfHeight);
        
        const landslideName = document.getElementById('landslide-name-input').value.trim();
        const fileName = landslideName ? `classification-${landslideName.replace(/\s+/g, '_')}.pdf` : 'landslide-dam-classification.pdf';
        pdf.save(fileName);

    } catch (err) {
        console.error("Error during PDF generation:", err);
        alert("An error occurred while generating the PDF.");
    } finally {
        document.body.removeChild(printableArea);
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save as PDF';
    }
}

function updateNavigation() {
    prevBtn.disabled = appState.currentStep === 0;
    const currentKey = stepKeys[appState.currentStep];
    nextBtn.disabled = !appState.selections[currentKey];
    stepIndicator.textContent = `Step ${appState.currentStep + 1} of ${stepKeys.length}`;
    updateProgressBar();
}

function init() {
    appState.currentStep = 0;
    appState.isComplex = false;
    for (let key in appState.selections) { 
        appState.selections[key] = null; 
    }
    stepKeys = ['alluvialPlain', 'riverbed', 'grainSize', 'landslideType', 'velocity', 'volume', 'material'];
    navigation.style.visibility = 'visible';
    progressContainer.style.visibility = 'visible';
    renderStep();
}

nextBtn.addEventListener('click', () => {
    if (appState.currentStep < stepKeys.length) {
        if (stepKeys[appState.currentStep] === 'landslideType' && appState.selections.landslideType?.code === 'C') {
            appState.isComplex = true;
            stepKeys = ['alluvialPlain', 'riverbed', 'grainSize', 'landslideType', 'complexCause', 'velocity', 'volume', 'material'];
        }
        
        appState.currentStep++;
        renderStep();
    }
});

prevBtn.addEventListener('click', () => {
    if (appState.currentStep > 0) {
        appState.currentStep--;
        
        if (stepKeys[appState.currentStep] === 'velocity') {
            const shouldSkip = (appState.selections.landslideType?.code === 'T' && !appState.isComplex) ||
                             (appState.isComplex && appState.selections.complexCause?.code === 'T');
            if (shouldSkip) {
                appState.currentStep--;
            }
        }
        
        if (stepKeys[appState.currentStep] === 'landslideType' && appState.isComplex) {
            appState.isComplex = false;
            appState.selections.complexCause = null;
            stepKeys = ['alluvialPlain', 'riverbed', 'grainSize', 'landslideType', 'velocity', 'volume', 'material'];
        }
        
        renderStep();
    }
});

window.addEventListener('DOMContentLoaded', loadExternalDatabase);
    </script>
</body>
</html>